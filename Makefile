.PHONY: help build build-all build-gitlab build-github build-bitbucket build-devops build-gitea test test-unit test-e2e lint clean coverage coverage-html serve-docs

# Default target
help:
	@echo "Pipeleak Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  make build            - Build the main pipeleak binary"
	@echo "  make build-all        - Build all binaries (main + platform-specific)"
	@echo "  make build-gitlab     - Build GitLab-specific binary"
	@echo "  make build-github     - Build GitHub-specific binary"
	@echo "  make build-bitbucket  - Build BitBucket-specific binary"
	@echo "  make build-devops     - Build Azure DevOps-specific binary"
	@echo "  make build-gitea      - Build Gitea-specific binary"
	@echo "  make test             - Run all tests (unit + e2e)"
	@echo "  make test-unit        - Run unit tests only"
	@echo "  make test-e2e         - Run e2e tests (builds binary first)"
	@echo "  make coverage         - Generate test coverage report"
	@echo "  make coverage-html    - Generate and open HTML coverage report"
	@echo "  make lint             - Run golangci-lint"
	@echo "  make serve-docs       - Generate and serve CLI documentation"
	@echo "  make clean            - Remove built artifacts"

# Build the main pipeleak binary
build:
	@echo "Building pipeleak..."
	go build -o pipeleak ./cmd/pipeleak

# Build GitLab-specific binary
build-gitlab:
	@echo "Building pipeleak-gitlab..."
	go build -o pipeleak-gitlab ./cmd/pipeleak-gitlab

# Build GitHub-specific binary
build-github:
	@echo "Building pipeleak-github..."
	go build -o pipeleak-github ./cmd/pipeleak-github

# Build BitBucket-specific binary
build-bitbucket:
	@echo "Building pipeleak-bitbucket..."
	go build -o pipeleak-bitbucket ./cmd/pipeleak-bitbucket

# Build Azure DevOps-specific binary
build-devops:
	@echo "Building pipeleak-devops..."
	go build -o pipeleak-devops ./cmd/pipeleak-devops

# Build Gitea-specific binary
build-gitea:
	@echo "Building pipeleak-gitea..."
	go build -o pipeleak-gitea ./cmd/pipeleak-gitea

# Build all binaries
build-all: build build-gitlab build-github build-bitbucket build-devops build-gitea
	@echo "All binaries built successfully"

# Run all tests
test: test-unit test-e2e

# Run unit tests (excluding e2e)
test-unit:
	@echo "Running unit tests..."
	go test $$(go list ./... | grep -v /tests/e2e) -v -race

# Run e2e tests (builds binary first)
test-e2e: build
	@echo "Running e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/... -tags=e2e -v -timeout 10m

# Run e2e tests for specific platform
test-e2e-gitlab: build
	@echo "Running GitLab e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/gitlab/... -tags=e2e -v

test-e2e-github: build
	@echo "Running GitHub e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/github/... -tags=e2e -v

test-e2e-bitbucket: build
	@echo "Running BitBucket e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/bitbucket/... -tags=e2e -v

test-e2e-devops: build
	@echo "Running Azure DevOps e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/devops/... -tags=e2e -v

test-e2e-gitea: build
	@echo "Running Gitea e2e tests..."
	PIPELEAK_BINARY=$$(pwd)/pipeleak go test ./tests/e2e/gitea/... -tags=e2e -v

# Generate test coverage report
coverage:
	@echo "Generating coverage report..."
	@go test $$(go list ./... | grep -v /tests/e2e) -coverprofile=coverage.out -covermode=atomic
	@echo ""
	@echo "Coverage Summary:"
	@go tool cover -func=coverage.out | grep total | awk '{print "Total Coverage: " $$3}'
	@echo ""
	@echo "Coverage report saved to coverage.out"
	@echo "Run 'make coverage-html' to view detailed HTML report"

# Generate and open HTML coverage report
coverage-html: coverage
	@echo "Generating HTML coverage report..."
	@go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report saved to coverage.html"
	@if command -v xdg-open > /dev/null; then \
		xdg-open coverage.html; \
	elif command -v open > /dev/null; then \
		open coverage.html; \
	else \
		echo "Open coverage.html in your browser to view the report"; \
	fi

# Run golangci-lint
lint:
	@echo "Running golangci-lint..."
	golangci-lint run --timeout=10m

# Generate and serve CLI documentation
serve-docs: build
	@echo "Generating and serving CLI documentation..."
	@if ! command -v mkdocs > /dev/null 2>&1; then \
		echo "MkDocs not found. Installing MkDocs and dependencies..."; \
		pip install mkdocs mkdocs-material mkdocs-minify-plugin; \
	fi
	./pipeleak docs -s

# Clean up built artifacts
clean:
	@echo "Cleaning up..."
	rm -f pipeleak pipeleak.exe coverage.out coverage.html
	rm -f pipeleak-gitlab pipeleak-gitlab.exe
	rm -f pipeleak-github pipeleak-github.exe
	rm -f pipeleak-bitbucket pipeleak-bitbucket.exe
	rm -f pipeleak-devops pipeleak-devops.exe
	rm -f pipeleak-gitea pipeleak-gitea.exe
	go clean -cache -testcache
